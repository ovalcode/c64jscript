<!DOCTYPE html>
<html>
  <head>
    <title>6502 Emulator From Scratch</title>
    <script src="Memory.js"></script>
    <script src="Cpu.js"></script>
    <script src="Video.js"></script>
    <script src="Keyboard.js"></script>
  </head>
  <body onkeydown="mykeyboard.onkeydown(event)" onkeyup="mykeyboard.onkeyup(event)">
    <h1>6502 Emulator From Scratch</h1>
    <p>This is JavaScript Test</p>
<canvas id="screen" width="320" height="200">

</canvas>
<br/>
<input type="file" id="files" name="myfile"/>
<button onclick="attachTape()">Attach</button>
</br>
<textarea id="registers" name="reg" rows="1" cols="60"></textarea>
<br/>
<textarea id="memory" name="mem" rows="15" cols="60"></textarea>
From Location:
<input type="text" id="frommem">
<button onclick="showMem()">Refresh Dump</button>
<br/>
<textarea id="diss" name="diss" rows="11" cols="60"></textarea>
<button id="btnStep" disabled = "true" onclick="step()">Step</button>
<button id="btnRun" disabled = "true" onclick="startEm()">Run</button>
<button id="btnStop" disabled = "true" onclick="stopEm()">Stop</button>
<br/>
Break at: <input type="text" id="breakpoint">
    <script language="JavaScript">

      var mykeyboard = new keyboard();
      var mymem = new memory(postInit,mykeyboard);
      var mycpu = new cpu(mymem);

      var myvideo = new video(document.getElementById("screen"), mymem);
      var mytimer;
      var running = false;
      var breakpoint = 0;
     
     function attachTape() {
       var reader = new FileReader();
basicRom = new Uint8Array(arrayBuffer);
  var kernalRom = new Uint8Array(8192);
       reader.onload = function(e) {
         var arrayBuffer = reader.result;
       }
       var file = document.getElementById("files");
       reader.readAsArrayBuffer(file);

     }

     function postInit() {
        document.getElementById("btnStep").disabled = false;
        document.getElementById("btnRun").disabled = false;
        document.getElementById("btnStop").disabled = false;
        mycpu.reset();
     }

      function showMem() {
        var m = document.getElementById("memory");
        var location = document.getElementById("frommem");
        locationInt = parseInt(location.value, 16);
        tempmemstr = ""
        for (i = locationInt; i < (160 + locationInt); i++) {
          if ((i % 16) == 0) {
            labelstr = "";
            labelstr = labelstr + "0000" + i.toString(16);
            labelstr = labelstr.slice(-4);

            tempmemstr = tempmemstr + "\n" + labelstr;
          }
          currentByte = "00" + mymem.readMem(i).toString(16);        
          currentByte = currentByte.slice(-2);
          tempmemstr = tempmemstr + " " + currentByte;
        }
        m.value = tempmemstr;

      }
      function runBatch() {
        if (!running)
          return;
        myvideo.updateCanvas();
        var targetCycleCount =  mycpu.getCycleCount() + 20000;
        while (mycpu.getCycleCount() < targetCycleCount) { 
          mycpu.step();
          if (mycpu.getCycleCount() > 6000000)            
            mymem.setSimulateKeypress();
          var blankingPeriodLow = targetCycleCount - 100;
          if ((mycpu.getCycleCount() >= blankingPeriodLow) & (mycpu.getCycleCount() <= targetCycleCount)) {
            mymem.writeMem(0xD012, 0);
          } else  {
            mymem.writeMem(0xD012, 1);
          }
          if (mycpu.getPc() == breakpoint) {
            stopEm();
            return;
          }
        }
        mycpu.setInterrupt();
      }
      
      function startEm() {
        document.getElementById("btnStep").disabled = true;
        document.getElementById("btnRun").blur();
        document.getElementById("btnRun").disabled = true;
        document.getElementById("btnStop").disabled = false;
        var myBreak = document.getElementById("breakpoint");
        breakpoint = parseInt(myBreak.value, 16);
        running = true;
        myTimer = setInterval(runBatch, 20);
      }

      function stopEm() {
        running = false;
        clearInterval(mytimer);
        displayEmuState();

        document.getElementById("btnStep").disabled = false;
        document.getElementById("btnRun").disabled = false;
        document.getElementById("btnStop").disabled = true;

      }
 
      function displayEmuState() {
        var t = document.getElementById("registers");
        t.value = mycpu.getDebugReg();
        
        var ins = document.getElementById("diss");
        ins.value = mycpu.getDecodedStr();
        showMem();
        t.value = mycpu.getDebugReg();

      }

      function step() {
        mycpu.step();
        displayEmuState();

        //alert(mycpu.getDebugReg());
      }

      /*mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();
      mycpu.step();

      alert(mymem.readMem(0x7d1));
      alert(mymem.readMem(0x7d2));
      alert(mymem.readMem(0x7d3));*/

    </script>
  </body>
</html>
